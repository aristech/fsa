name: Task Reminder Cron Job

on:
  schedule:
    # Run every 30 minutes
    - cron: "*/30 * * * *"
  workflow_dispatch: # Allow manual trigger for testing

jobs:
  process-reminders:
    name: Process Task Reminders
    runs-on: self-hosted
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Check deployment health
        run: |
          echo "Checking if backend service is running..."
          if curl -f http://localhost:4005/api/health >/dev/null 2>&1; then
            echo "✅ Backend service is healthy"
          else
            echo "❌ Backend service is not responding - skipping reminder processing"
            exit 1
          fi

      - name: Process pending reminders
        run: |
          echo "Processing task reminders..."

          # Call the reminder processing endpoint
          RESPONSE=$(curl -s -w "%{http_code}" -X POST http://localhost:4005/api/v1/reminders/process -o /tmp/reminder_response.json)
          HTTP_CODE=$(echo $RESPONSE | tail -c 4)

          if [ "$HTTP_CODE" = "200" ]; then
            echo "✅ Reminder processing completed successfully"
            cat /tmp/reminder_response.json | jq '.'
          else
            echo "❌ Reminder processing failed with HTTP code: $HTTP_CODE"
            cat /tmp/reminder_response.json || echo "No response body"
            exit 1
          fi

      - name: Log reminder processing status
        if: always()
        run: |
          TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S')
          LOG_DIR="/var/www/progressnet.io-app/logs"

          if [ -f "/tmp/reminder_response.json" ]; then
            PROCESSED=$(cat /tmp/reminder_response.json | jq -r '.processed // 0')
            ERRORS=$(cat /tmp/reminder_response.json | jq -r '.errors // []' | jq length)

            echo "[$TIMESTAMP] Processed: $PROCESSED reminders, Errors: $ERRORS" >> $LOG_DIR/reminder-cron.log

            # Keep only last 100 lines of log
            tail -n 100 $LOG_DIR/reminder-cron.log > $LOG_DIR/reminder-cron.log.tmp
            mv $LOG_DIR/reminder-cron.log.tmp $LOG_DIR/reminder-cron.log
          else
            echo "[$TIMESTAMP] Reminder processing failed - no response" >> $LOG_DIR/reminder-cron.log
          fi

          # Clean up temporary files
          rm -f /tmp/reminder_response.json

      - name: Health check after processing
        run: |
          echo "Final health check after reminder processing..."

          # Check if all services are still healthy
          BACKEND_STATUS="unknown"
          FRONTEND_STATUS="unknown"

          if curl -f http://localhost:4005/api/health >/dev/null 2>&1; then
            BACKEND_STATUS="healthy"
          else
            BACKEND_STATUS="unhealthy"
          fi

          if curl -f http://localhost:4004 >/dev/null 2>&1; then
            FRONTEND_STATUS="healthy"
          else
            FRONTEND_STATUS="unhealthy"
          fi

          echo "Service Health Status:"
          echo "Backend (4005): $BACKEND_STATUS"
          echo "Frontend (4004): $FRONTEND_STATUS"

          # Alert if any critical service is down
          if [ "$BACKEND_STATUS" != "healthy" ]; then
            echo "🚨 WARNING: Backend service is unhealthy after reminder processing"
          fi
